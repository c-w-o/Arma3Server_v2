# Generated workflow file restored with Bandit and Anchore sections included
defaults:
  run:
    working-directory: ./

name: CI/CD Pipeline

on:
  push:
    branches:
      - "main"
      - "**/feature/*"
  pull_request:
    branches:
      - "main"
    types: [opened, synchronize]

jobs:
  pylint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]
    steps:
    - uses: actions/checkout@v6
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint
    - name: Analysing the code with pylint
      run: |
        # Create a temporary file to capture pylint output
        pylint_output_file="pylint_output.txt"
        
        # Run pylint and capture output (both stdout and stderr)
        pylint $(git ls-files '*.py') > "$pylint_output_file" 2>&1 || true
        
        # Show output in console
        cat "$pylint_output_file"
        
        # Use awk to parse and format the entire summary
        awk -v python_version="${{ matrix.python-version }}" '
        BEGIN {
          # Initialize counters
          score = "N/A"
          fatal = 0; error = 0; warning = 0; convention = 0; refactor = 0
          
          # Print header
          print "## üîç Pylint Analysis Results (Python " python_version ")"
          print ""
        }
        
        # Extract score
        /Your code has been rated at [0-9.]+/ {
          if (match($0, /rated at ([0-9.]+)/, arr)) {
            score = arr[1]
          }
        }
        
        # Process each line to count issues
        /^[^:]+:[0-9]+:[0-9]+: [A-Z]/ {
          # Extract the message type (F, E, W, C, R)
          type = substr($0, index($0, ":") + 1, 1)
          if (type == "F") {
            fatal++
          } else if (type == "E") {
            error++
          } else if (type == "W") {
            warning++
          } else if (type == "C") {
            convention++
          } else if (type == "R") {
            refactor++
          }
        }
        
        END {
          # Calculate totals
          total_issues = fatal + error + warning + convention + refactor
          
          # Print category breakdown
          print "### Summary"
          print ""
          print "| Category | Count | Description |"
          print "|----------|-------|-------------|"
          printf "| **Score** | %s/10 | Global Score of the Codebase |\n", score
          print "| **Total Issues** | " total_issues " | Total Number of Issues |"
          print "| **Fatal (F)** | " fatal " | Fatal errors preventing analysis |"
          print "| **Errors (E)** | " error " | Other Errors |"
          print "| **Warnings (W)** | " warning " | Warnings |"
          print "| **Conventions (C)** | " convention " | Coding Conventions |"
          print "| **Refactors (R)** | " refactor " | Refactor Suggestions |"
          print ""
          print "üéâ Analysis complete!"
        }


  bandit:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]
    permissions:
      # required for all workflows
      security-events: write
      # only required for workflows in private repositories
      actions: read
      contents: read
    steps:
      - name: Perform Bandit Analysis with ${{ matrix.python-version }}
        uses: PyCQA/bandit-action@v1
  anchore:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: build local container
      uses: docker/build-push-action@v6
      with:
        tags: localbuild/testimage:latest
        push: false
        load: true

    - name: Scan image
      uses: anchore/scan-action@v7
      id: scan
      with:
        image: "localbuild/testimage:latest"
        fail-build: false
    - name: Upload Anchore scan SARIF report
      uses: github/codeql-action/upload-sarif@v4
      with:
        sarif_file: ${{ steps.scan.outputs.sarif }}
    - name: Inspect action SARIF report
      run: cat ${{ steps.scan.outputs.sarif }}