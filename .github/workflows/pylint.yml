name: Pylint

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint
    - name: Analysing the code with pylint
      run: |
        # Create a temporary file to capture pylint output
        pylint_output_file="pylint_output.txt"
        
        # Run pylint and capture output (both stdout and stderr)
        pylint $(git ls-files '*.py') > "$pylint_output_file" 2>&1 || true
        
        # Extract the score if present
        pylint_score=$(grep -oP 'Your code has been rated at \K[0-9.]+' "$pylint_output_file" | head -1 || echo "N/A")
        
        # Count errors (E, F message codes) and warnings (W, C, R message codes)
        # E = Error, F = Fatal, W = Warning, C = Convention, R = Refactor
        errors=$(grep -c -E ':[[:space:]]+[EF][0-9]+:' "$pylint_output_file" || true)
        errors=${errors:-0}
        warnings=$(grep -c -E ':[[:space:]]+[WCR][0-9]+:' "$pylint_output_file" || true)
        warnings=${warnings:-0}
        
        # Get summary statistics by category
        fatal_count=$(grep -c -E ':[[:space:]]+F[0-9]+:' "$pylint_output_file" || true)
        fatal_count=${fatal_count:-0}
        error_count=$(grep -c -E ':[[:space:]]+E[0-9]+:' "$pylint_output_file" || true)
        error_count=${error_count:-0}
        warning_count=$(grep -c -E ':[[:space:]]+W[0-9]+:' "$pylint_output_file" || true)
        warning_count=${warning_count:-0}
        convention_count=$(grep -c -E ':[[:space:]]+C[0-9]+:' "$pylint_output_file" || true)
        convention_count=${convention_count:-0}
        refactor_count=$(grep -c -E ':[[:space:]]+R[0-9]+:' "$pylint_output_file" || true)
        refactor_count=${refactor_count:-0}
        
        # Get top 5 files with most issues
        top_files=$(grep -E '^[^:]+:[0-9]+:[0-9]+:' "$pylint_output_file" 2>/dev/null | \
                    cut -d: -f1 | \
                    sort | uniq -c | sort -rn | head -5 | \
                    awk '{print "  - " $2 ": " $1 " issues"}')
        
        # Format the summary
        echo "## ðŸ” Pylint Analysis Results (Python ${{ matrix.python-version }})" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“Š Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Score** | $pylint_score/10 |" >> $GITHUB_STEP_SUMMARY
        echo "| **Total Issues** | $((errors + warnings)) |" >> $GITHUB_STEP_SUMMARY
        echo "| **Errors (E/F)** | $errors |" >> $GITHUB_STEP_SUMMARY
        echo "| **Warnings (W/C/R)** | $warnings |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“ˆ Breakdown by Category" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| **Fatal (F)** | $fatal_count |" >> $GITHUB_STEP_SUMMARY
        echo "| **Error (E)** | $error_count |" >> $GITHUB_STEP_SUMMARY
        echo "| **Warning (W)** | $warning_count |" >> $GITHUB_STEP_SUMMARY
        echo "| **Convention (C)** | $convention_count |" >> $GITHUB_STEP_SUMMARY
        echo "| **Refactor (R)** | $refactor_count |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "$top_files" ]; then
          echo "### ðŸ“‹ Top Files with Issues" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "$top_files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # Add detailed output in collapsed section
        echo "### ðŸ“ Detailed Output" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "<details>" >> $GITHUB_STEP_SUMMARY
        echo "<summary>Click to view full pylint output</summary>" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat "$pylint_output_file" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "</details>" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Show the output in console as well
        cat "$pylint_output_file"
        
        # Exit with non-zero if there are errors (optional)
        if [ "$errors" -gt 0 ]; then
          echo "::warning::Pylint found $errors error(s)"
          # Uncomment below to fail the workflow on errors:
          # exit 1
        fi
