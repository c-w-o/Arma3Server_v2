name: Linting

on:
  push:
    branches:
      - "main"
      - "**/feature/*"
  pull_request:
    branches:
      - "main"
    types: [opened, synchronize]

jobs:
  pylint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]
    steps:
    - uses: actions/checkout@v6
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint
    - name: Analysing the code with pylint
      run: |
        # Create a temporary file to capture pylint output
        pylint_output_file="pylint_output.txt"
        
        # Run pylint and capture output (both stdout and stderr)
        pylint $(git ls-files '*.py') > "$pylint_output_file" 2>&1 || true
        
        # Show output in console
        cat "$pylint_output_file"
        
        # Use awk to parse and format the entire summary
        awk -v python_version="${{ matrix.python-version }}" '
        BEGIN {
          # Initialize counters
          score = "N/A"
          fatal = 0; error = 0; warning = 0; convention = 0; refactor = 0
          
          # Print header
          print "## ðŸ” Pylint Analysis Results (Python " python_version ")"
          print ""
        }
        
        # Extract score
        /Your code has been rated at [0-9.]+/ {
          if (match($0, /rated at ([0-9.]+)/, arr)) {
            score = arr[1]
          }
        }
        
        # Process each line to count issues
        /^[^:]+:[0-9]+:[0-9]+: [A-Z]/ {
          # Extract the message type (F, E, W, C, R)
          type = substr($0, index($0, ":") + 1, 1)
          if (type == "F") {
            fatal++
          } else if (type == "E") {
            error++
          } else if (type == "W") {
            warning++
          } else if (type == "C") {
            convention++
          } else if (type == "R") {
            refactor++
          }
        }
        
        END {
          # Calculate totals
          total_issues = fatal + error + warning + convention + refactor
          
          # Print category breakdown
          print "### Summary"
          print ""
          print "| Category | Count | Description |"
          print "|----------|-------|-------------|"
          printf "| **Score** | %s/10 | Global Score of the Codebase |\n", score
          print "| **Total Issues** | " total_issues " | Total Number of Issues |"
          print "| **Fatal (F)** | " fatal " | Fatal errors preventing analysis |"
          print "| **Errors (E)** | " error " | Other Errors |"
          print "| **Warnings (W)** | " warning " | Warnings |"
          print "| **Conventions (C)** | " convention " | Coding Conventions |"
          print "| **Refactors (R)** | " refactor " | Refactor Suggestions |"
          print ""
          print "ðŸŽ‰ Analysis complete!"
        }
        ' "$pylint_output_file" >> "$GITHUB_STEP_SUMMARY"
        
        # Append the actual pylint output to the summary
        echo '<details><summary> Full Pylint Output</summary>' >> "$GITHUB_STEP_SUMMARY"
        echo '' >> "$GITHUB_STEP_SUMMARY"
        echo '```' >> "$GITHUB_STEP_SUMMARY"
        cat "$pylint_output_file" >> "$GITHUB_STEP_SUMMARY"
        echo '```' >> "$GITHUB_STEP_SUMMARY"
        echo '' >> "$GITHUB_STEP_SUMMARY"
        echo '</details>' >> "$GITHUB_STEP_SUMMARY"
        echo '' >> "$GITHUB_STEP_SUMMARY"
        
        # Check if there are errors and optionally fail
        # Extract error count from the file for conditional exit
        error_count=$(grep -c -E ':[[:space:]]+[EF][0-9]+:' "$pylint_output_file" 2>/dev/null || echo "0")
        if [ "$error_count" -gt 0 ]; then
          echo "::warning::Pylint found $error_count error(s)"
          # Uncomment below to fail the workflow on errors:
          # exit 1
        fi

  ruff:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Ruff
        uses: astral-sh/ruff-action@v3
        with:
          version: "latest"
      - name: Run Ruff and parse output
        run: |
          # Create a temporary file to capture ruff output
          ruff_output_file="ruff_output.txt"
          
          # Run ruff and capture output
          ruff check . > "$ruff_output_file" 2>&1 || true
          
          # Show output in console
          cat "$ruff_output_file"
          
          # Parse and format ruff output
          awk '
          BEGIN {
            error = 0
            warning = 0
            
            # Print header
            print "## ðŸ” Ruff Analysis Results"
            print ""
          }
          
          # Count errors and warnings from GitHub annotation format
          /::error/ {
            error++
            next
          }
          /::warning/ {
            warning++
            next
          }
          
          # Also count from standard ruff output format
          /^[^:]+:[0-9]+:[0-9]+: [A-Z]/ {
            code = substr($0, index($0, ":") + 1)
            if (code ~ /^[[:space:]]*[EF]/) {
              error++
            } else if (code ~ /^[[:space:]]*W/) {
              warning++
            }
          }
          
          END {
            total_issues = error + warning
            
            # Print category breakdown
            print "### Summary"
            print ""
            print "| Category | Count |"
            print "|----------|-------|"
            print "| **Total Issues** | " total_issues " |"
            print "| **Errors** | " error " |"
            print "| **Warnings** | " warning " |"
            print ""
          }
          ' "$ruff_output_file" >> "$GITHUB_STEP_SUMMARY"
          
          # Append full output to summary
          echo '<details><summary>Full Ruff Output</summary>' >> "$GITHUB_STEP_SUMMARY"
          echo '' >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          cat "$ruff_output_file" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
          echo '</details>' >> "$GITHUB_STEP_SUMMARY"

